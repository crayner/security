<?php
namespace Hillrange\Security\Repository;

use Hillrange\Security\Entity\Page;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Symfony\Bridge\Doctrine\RegistryInterface;
use Symfony\Component\Routing\RouterInterface;

/**
 * PageRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PageRepository extends ServiceEntityRepository
{
	/**
	 * @var RouterInterface
	 */
	private $router;

	/**
	 * PageRepository constructor.
	 *
	 * @param RegistryInterface $registry
	 */
	public function __construct(RegistryInterface $registry, RouterInterface $router)
	{
		parent::__construct($registry, Page::class);

		$this->router = $router;
	}

	/**
	 * @param $routeName
	 *
	 * @return Page
	 */
	public function loadOneByRoute(string $routeName = null, array $params = []): ?Page
	{
		if (! $routeName)
			return null;

		$page = $this->createQueryBuilder('p')
			->where('p.route = :route')
			->setParameter('route', $routeName)
			->getQuery()
			->getOneOrNullResult();

		if (empty($page))
		{
			$page = new Page();
			$page->setRoute($routeName);
			$page->setPath($this->router->generate($routeName, $params));
		}

		return $page;
	}
}
